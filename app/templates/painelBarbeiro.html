<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Barbeiro</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='logo barber wise sem_fundo.png') }}"
        type="image/x-icon" />
    <link rel="stylesheet" href="{{url_for('static', filename='css/painelCliente.css')}}">
    <!-- Bootstrap CSS e JS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <!--Biblioteca SweetAlert-->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <div class="main">
        <!--Navega√ß√£o-->
        <nav class="top-nav">
            <div class="container_logo">
                <img src="{{url_for('static', filename='css/img/logo barber wise sem_fundo_letra_branca.png')}}"
                    alt="Logo Barber Wise">
            </div>
            <div class="titulo">
                <h2>Barber Wise</h2>
            </div>
            <input id="menu-toggle" type="checkbox" />
            <label class='menu-button-container' for="menu-toggle">
                <div class='menu-button'></div>
            </label>
            <ul class="menu">
                <li>Sobre</li>
                <li>Servi√ßo</li>
                <li>Contato</li>
            </ul>
        </nav>
        <!--Fim da navega√ß√£o-->

        <!--Container do calend√°rio-->
        <div id="container_caledary">
            <div class="calendar">
                <div class="calendar-header">
                    <button id="prevMonth">&lt;</button>
                    <div id="monthYear"></div>
                    <button id="nextMonth">&gt;</button>
                </div>
                <div class="calendar-body">
                    <div class="calendar-weekdays">
                        <div>Segunda</div>
                        <div>Ter√ßa</div>
                        <div>Quarta</div>
                        <div>Quinta</div>
                        <div>Sexta</div>
                        <div>S√°bado</div>
                        <div>Domingo</div>
                    </div>
                    <div class="calendar-days" id="calendarDays"></div>
                </div>
            </div>
        </div>

        <!-- Modal do Bootstrap para informa√ß√µes do cliente -->
        <div class="modal fade" id="customerInfoModal" tabindex="-1" aria-labelledby="customerInfoModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="customerInfoModalLabel">Informa√ß√µes do Cliente</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="customerName" class="form-label"><i class="bi bi-person-fill"></i> Nome</label>
                            <input type="text" class="form-control" id="customerName" disabled>
                        </div>
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label"><i class="bi bi-telephone-fill"></i>
                                Telefone</label>
                            <input type="text" class="form-control" id="customerPhone" disabled>
                        </div>
                        <div class="mb-3">
                            <label for="customerEmail" class="form-label"><i class="bi bi-envelope-fill"></i>
                                E-mail</label>
                            <input type="email" class="form-control" id="customerEmail" disabled>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal do Bootstrap para selecionar hor√°rio -->
        <div class="modal fade" id="timeModal" tabindex="-1" aria-labelledby="timeModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="timeModalLabel">Selecione um hor√°rio</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Hor√°rios dispon√≠veis -->
                        <div id="timeOptions" class="d-flex flex-wrap gap-2"></div>

                        <!-- Sele√ß√£o de Barbearia -->
                        <div id="barber-selection" class="mt-4" style="display: none;">
                            <label for="barberSelect" class="form-label">Selecione a Barbearia:</label>
                            <select id="barberSelect" class="form-select"></select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button id="confirmTime" class="btn btn-primary" disabled>Confirmar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--Scripts-->
    <script>
        const calendarDays = document.getElementById('calendarDays');
        const monthYear = document.getElementById('monthYear');
        const prevMonth = document.getElementById('prevMonth');
        const nextMonth = document.getElementById('nextMonth');
        const confirmTime = document.getElementById('confirmTime');
        const timeOptions = document.getElementById('timeOptions');
        const timeModal = new bootstrap.Modal(document.getElementById('timeModal'));
        const customerInfoModal = new bootstrap.Modal(document.getElementById('customerInfoModal'));
        let selectedDate = null;
        let selectedTime = null;
        let selectedCustomer = null;

        // Array com os meses do ano
        const months = [
            'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];

        // Data atual
        let date = new Date();

        // Fun√ß√£o para renderizar o calend√°rio
        function renderCalendar() {
            calendarDays.innerHTML = '';
            const month = date.getMonth();
            const year = date.getFullYear();
            monthYear.innerText = `${months[month]} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();

            // Adiciona dias vazios no in√≠cio
            for (let i = 0; i < (firstDay || 7) - 1; i++) {
                calendarDays.innerHTML += `<div class="empty"></div>`;
            }

            // Adiciona os dias do m√™s
            for (let i = 1; i <= lastDate; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'day';
                dayElement.innerText = i;

                if (selectedDate === `${i}/${month + 1}/${year}`) {
                    dayElement.classList.add('selected');
                }

                dayElement.addEventListener('click', function () {
                    selectedDate = `${i}/${month + 1}/${year}`;
                    document.querySelectorAll('.day').forEach(day => day.classList.remove('selected'));
                    dayElement.classList.add('selected');
                    renderTimeOptions(); // Agora, chama a fun√ß√£o para renderizar os hor√°rios
                    timeModal.show(); // Mostra o modal de hor√°rios
                });

                calendarDays.appendChild(dayElement);
            }
        }

        // Fun√ß√£o para fazer login do barbeiro
        function loginBarbeiro(email, senha) {
            fetch('/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email: email, senha: senha }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Armazena o barbeiro_id no sessionStorage
                        sessionStorage.setItem('barbeiro_id', data.barbeiro_id);
                        console.log("Barbeiro ID armazenado no sessionStorage:", data.barbeiro_id);
                        // Redireciona ou faz algo ap√≥s o login
                    } else {
                        console.error("Erro no login:", data.message);
                    }
                })
                .catch(error => {
                    console.error("Erro ao fazer login:", error);
                });
        }

        // Fun√ß√£o para renderizar os hor√°rios dispon√≠veis
        function getBarberId() {
            console.log("Executando getBarberId()...");

            return new Promise((resolve, reject) => {
                const barberId = sessionStorage.getItem('barbeiro_id');
                console.log("Valor no sessionStorage:", barberId);

                if (barberId) {
                    console.log("Resolvendo com ID do sessionStorage:", barberId);
                    resolve(barberId); // Retorna o ID salvo no navegador
                } else {
                    console.log("Buscando ID no backend...");
                    fetch('/get_barbeiro_id') // Faz requisi√ß√£o para o backend
                        .then(response => {
                            console.log("Resposta recebida do backend:", response);
                            return response.json();
                        })
                        .then(data => {
                            console.log("Dados convertidos:", data);
                            if (data.barbeiro_id) {
                                sessionStorage.setItem('barbeiro_id', data.barbeiro_id); // Salva no sessionStorage
                                console.log("Resolvendo com ID do backend:", data.barbeiro_id);
                                resolve(data.barbeiro_id);
                            } else {
                                console.error("Erro: Barbeiro n√£o autenticado!");
                                reject('Barbeiro n√£o autenticado');
                            }
                        })
                        .catch(error => {
                            console.error("Erro ao buscar ID no backend:", error);
                            reject(error);
                        });
                }
            });
        }




        
        // Fun√ß√£o para renderizar os hor√°rios dispon√≠veis
        function renderTimeOptions() {
            console.log("Chamando renderTimeOptions...");

            const selectedDateFormatted = formatDateForAPI(selectedDate);
            console.log("Data formatada:", selectedDateFormatted);

            getBarberId().then(barbeiro_id => {
                if (!barbeiro_id) {
                    Swal.fire('Erro', 'Barbeiro n√£o autenticado!', 'error');
                    return;
                }

                console.log("Barbeiro ID recebido:", barbeiro_id);

                $.ajax({
                    url: '/get_agendamentos',
                    method: 'GET',
                    data: { barbeiro_id: barbeiro_id, data: selectedDateFormatted },
                    success: function (response) {
                        console.log("Resposta da API:", response);
                        if (response.status === 'success') {
                            // Renderizar hor√°rios aqui
                        } else {
                            Swal.fire('Erro', response.message, 'error');
                        }
                    },
                    error: function () {
                        Swal.fire('Erro', 'N√£o foi poss√≠vel carregar os hor√°rios agendados.', 'error');
                    }
                });
            }).catch(error => {
                console.error("Erro em renderTimeOptions:", error);
                Swal.fire('Erro', 'Falha ao obter agendamentos.', 'error');
            });
        }

        // Fun√ß√£o para confirmar o agendamentos
        function confirmarAgendamento(cliente_id, dataSelecionada, horario_agd) {
            console.log("Enviando agendamento:", { cliente_id, data: dataSelecionada, horario_agd });

            $.ajax({
                url: '/confirm_agd',
                method: 'POST',
                contentType: 'application/json',  // üî• Define JSON no cabe√ßalho
                data: JSON.stringify({
                    cliente_id: cliente_id,
                    data_agendamento: dataSelecionada,
                    horario_agd: horario_agd
                }),
                success: function (response) {
                    Swal.fire('Sucesso', 'Agendamento confirmado!', 'success');
                },
                error: function (xhr) {
                    console.error("Erro ao agendar:", xhr.responseText);
                    Swal.fire('Erro', 'Falha ao confirmar o agendamento.', 'error');
                }
            });

        }


        // Fun√ß√£o para formatar a data corretamente (YYYY-MM-DD)
        function formatDateForAPI(date) {
            const [day, month, year] = date.split('/');
            return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`; // Formato correto para API
        }

        // Fun√ß√£o para esconder o modal de hor√°rios
        function hideTimeModal() {
            document.querySelector('#timeOptions').style.display = 'none'; // Esconde as op√ß√µes de hor√°rio
            document.querySelector('#barber-selection').style.display = 'none'; // Esconde a sele√ß√£o de barbeiro, se aplic√°vel
            $('#timeModal').modal('hide'); // Fecha o modal
        }

        // Fun√ß√£o para navegar entre os meses
        prevMonth.addEventListener('click', () => {
            date.setMonth(date.getMonth() - 1);
            renderCalendar(); // Renderiza o calend√°rio do m√™s anterior
        });

        nextMonth.addEventListener('click', () => {
            date.setMonth(date.getMonth() + 1);
            renderCalendar(); // Renderiza o calend√°rio do pr√≥ximo m√™s
        });

        // Renderiza o calend√°rio inicial
        renderCalendar();
    </script>


</body>

</html>